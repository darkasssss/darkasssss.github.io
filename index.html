<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Master</title>
    <style>


        .quiz-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.btn-quit {
    background: linear-gradient(45deg, #f44336, #e57373);
    color: white;
    border: 2px solid rgba(244, 67, 54, 0.3);
    padding: 10px 20px;
    font-size: 0.9rem;
}

.btn-quit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
}

.resume-section {
    background: rgba(255, 193, 7, 0.1);
    border: 2px solid rgba(255, 193, 7, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e0e6ed;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #64ffda, #00bcd4, #26c6da);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(100, 255, 218, 0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #b0bec5;
            opacity: 0.8;
        }

        .main-buttons {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #1e88e5, #26c6da);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 136, 229, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #7e57c2, #9c27b0);
            color: white;
            box-shadow: 0 4px 15px rgba(126, 87, 194, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(126, 87, 194, 0.6);
        }

        .content-section {
            display: none;
            width: 100%;
            max-width: 800px;
            animation: fadeIn 0.5s ease-in;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 255, 218, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subject-card {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.1), rgba(0, 188, 212, 0.1));
            border: 2px solid rgba(100, 255, 218, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            border-color: #64ffda;
            box-shadow: 0 10px 30px rgba(100, 255, 218, 0.3);
        }

        .formatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .formative-card {
            background: linear-gradient(135deg, rgba(30, 136, 229, 0.2), rgba(38, 198, 218, 0.2));
            border: 2px solid rgba(30, 136, 229, 0.5);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .formative-card:hover {
            transform: scale(1.05);
            border-color: #1e88e5;
            box-shadow: 0 5px 20px rgba(30, 136, 229, 0.4);
        }

        .quiz-container {
            text-align: center;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(100, 255, 218, 0.2);
        }

        .question-number {
            font-size: 1rem;
            color: #64ffda;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.3rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(100, 255, 218, 0.3);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .option:hover {
            background: rgba(100, 255, 218, 0.1);
            border-color: #64ffda;
        }

        .option.selected {
            background: rgba(30, 136, 229, 0.3);
            border-color: #1e88e5;
        }

        .option.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
            animation: correctPulse 0.6s ease;
        }

        .option.incorrect {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
            animation: incorrectShake 0.6s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .quiz-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #64ffda, #26c6da);
            height: 100%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #64ffda;
            font-weight: bold;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(100, 255, 218, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e6ed;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }

        .back-btn {
            margin-bottom: 20px;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            color: #64ffda;
            border: 2px solid rgba(100, 255, 218, 0.3);
        }

        .btn-back:hover {
            background: rgba(100, 255, 218, 0.1);
            border-color: #64ffda;
        }

        .admin-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
<div class="admin-card" onclick="showFileUpload()">
    <h3>Load from Files</h3>
    <p>Load questions from repository files</p>
</div>
        .admin-card {
            background: linear-gradient(135deg, rgba(126, 87, 194, 0.2), rgba(156, 39, 176, 0.2));
            border: 2px solid rgba(126, 87, 194, 0.5);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-5px);
            border-color: #7e57c2;
            box-shadow: 0 10px 30px rgba(126, 87, 194, 0.3);
        }

        .results-card {
            text-align: center;
            padding: 40px;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .score.excellent {
            color: #4caf50;
        }

        .score.good {
            color: #2196f3;
        }

        .score.average {
            color: #ff9800;
        }

        .score.poor {
            color: #f44336;
        }

        .hidden {
            display: none !important;
        }
<!-- Edit Question Section -->
<div id="edit-question-section" class="content-section">
    <div class="back-btn">
        <button class="btn btn-back" onclick="showManageQuestions()">← Back to Questions</button>
    </div>
    <div class="card">
        <h2>Edit Question</h2>
        <div class="form-group">
            <label for="edit-question">Question:</label>
            <textarea id="edit-question" rows="3" placeholder="Enter your question"></textarea>
        </div>
        <div class="form-group">
            <label for="edit-option-a">Option A:</label>
            <input type="text" id="edit-option-a" placeholder="Enter option A">
        </div>
        <div class="form-group">
            <label for="edit-option-b">Option B:</label>
            <input type="text" id="edit-option-b" placeholder="Enter option B">
        </div>
        <div class="form-group">
            <label for="edit-option-c">Option C:</label>
            <input type="text" id="edit-option-c" placeholder="Enter option C">
        </div>
        <div class="form-group">
            <label for="edit-option-d">Option D:</label>
            <input type="text" id="edit-option-d" placeholder="Enter option D">
        </div>
        <div class="form-group">
            <label for="edit-correct-answer">Correct Answer:</label>
            <select id="edit-correct-answer">
                <option value="A">Option A</option>
                <option value="B">Option B</option>
                <option value="C">Option C</option>
                <option value="D">Option D</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="updateQuestion()">Update Question</button>
    </div>
</div>

<!-- File Upload Section -->
<div id="file-upload-section" class="content-section">
    <div class="back-btn">
        <button class="btn btn-back" onclick="showAdmin()">← Back to Admin</button>
    </div>
    <div class="card">
        <h2>Load Questions from Files</h2>
        <div class="form-group">
            <label for="file-input">Select JSON file:</label>
            <input type="file" id="file-input" accept=".json" onchange="loadFileContent(event)">
        </div>
        <div class="form-group">
            <label>Or refresh from repository:</label>
            <button class="btn btn-primary" onclick="loadFromRepository()">Refresh from Repository</button>
        </div>
    </div>
</div>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
        }

        .notification.error {
            background: linear-gradient(45deg, #f44336, #e57373);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Section -->
        <div id="home-section" class="content-section active">
            <div class="header">
                <h1>Quiz Master</h1>
                <p>Test your knowledge with our interactive quizzes</p>
            </div>
            <div class="main-buttons">
                <button class="btn btn-primary" onclick="showSubjects()">Start Quiz</button>
                <button class="btn btn-secondary" onclick="showLogin()">Admin</button>
            </div>
        </div>

        <!-- Subjects Section -->
        <div id="subjects-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showHome()">← Back to Home</button>
            </div>
            <div class="card">
                <h2>Select a Subject</h2>
                <div id="subjects-container" class="subjects-grid">
                    <!-- Subjects will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Formatives Section -->
        <div id="formatives-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showSubjects()">← Back to Subjects</button>
            </div>
            <div class="card">
                <h2 id="formatives-title">Select a Formative</h2>
                <div id="formatives-container" class="formatives-grid">
                    <!-- Formatives will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Quiz Section -->
<div id="quiz-section" class="content-section">
    <div class="quiz-container">
        <div class="quiz-controls">
            <div class="quiz-progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
            <button class="btn btn-quit" onclick="quitQuiz()">Quit Quiz</button>
        </div>
        <div id="quiz-content">
            <!-- Quiz questions will be loaded here -->
        </div>
    </div>
</div>

        <!-- Results Section -->
        <div id="results-section" class="content-section">
            <div class="card results-card">
                <h2>Quiz Complete!</h2>
                <div id="final-score" class="score"></div>
                <div id="score-message"></div>
                <button class="btn btn-primary" onclick="showHome()" style="margin-top: 20px;">Take Another Quiz</button>
            </div>
        </div>

        <!-- Login Section -->
        <div id="login-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showHome()">← Back to Home</button>
            </div>
            <div class="card">
                <h2>Admin Login</h2>
                <div class="login-form">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" placeholder="Enter password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                </div>
            </div>
        </div>

        <!-- Admin Panel Section -->
        <div id="admin-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="logout()">← Logout</button>
            </div>
            <div class="card">
                <h2>Admin Panel</h2>
                <div class="admin-panel">
                    <div class="admin-card" onclick="showCreateSubject()">
                        <h3>Create Subject</h3>
                        <p>Add new quiz subjects</p>
                    </div>
                    <div class="admin-card" onclick="showCreateFormative()">
                        <h3>Create Formative</h3>
                        <p>Add new formatives to subjects</p>
                    </div>
                    <div class="admin-card" onclick="showManageQuestions()">
                        <h3>Manage Questions</h3>
                        <p>Edit questions in formatives</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Subject Section -->
        <div id="create-subject-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showAdmin()">← Back to Admin</button>
            </div>
            <div class="card">
                <h2>Create New Subject</h2>
                <div class="form-group">
                    <label for="subject-name">Subject Name:</label>
                    <input type="text" id="subject-name" placeholder="Enter subject name">
                </div>
                <button class="btn btn-primary" onclick="createSubject()">Create Subject</button>
            </div>
        </div>

        <!-- Create Formative Section -->
        <div id="create-formative-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showAdmin()">← Back to Admin</button>
            </div>
            <div class="card">
                <h2>Create New Formative</h2>
                <div class="form-group">
                    <label for="formative-subject">Select Subject:</label>
                    <select id="formative-subject">
                        <option value="">Choose a subject</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formative-number">Formative Number (1-4):</label>
                    <select id="formative-number">
                        <option value="1">Formative 1</option>
                        <option value="2">Formative 2</option>
                        <option value="3">Formative 3</option>
                        <option value="4">Formative 4</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="createFormative()">Create Formative</button>
            </div>
        </div>


        <!-- Resume Quiz Section -->
<div id="resume-section" class="content-section">
    <div class="back-btn">
        <button class="btn btn-back" onclick="showFormatives(currentQuiz.subject)">← Back to Formatives</button>
    </div>
    <div class="card">
        <div class="resume-section">
            <h3>Resume Previous Quiz</h3>
            <p>You have an unfinished quiz in <strong id="resume-subject"></strong> - <strong id="resume-formative"></strong></p>
            <p>Progress: <span id="resume-progress"></span></p>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="resumeQuiz()" style="margin-right: 10px;">Resume Quiz</button>
                <button class="btn btn-secondary" onclick="startNewQuiz()">Start New Quiz</button>
            </div>
        </div>
    </div>
</div>

        <!-- Manage Questions Section -->
        <div id="manage-questions-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showAdmin()">← Back to Admin</button>
            </div>
            <div class="card">
                <h2>Manage Questions</h2>
                <div class="form-group">
                    <label for="question-subject">Select Subject:</label>
                    <select id="question-subject" onchange="loadFormativesForQuestions()">
                        <option value="">Choose a subject</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="question-formative">Select Formative:</label>
                    <select id="question-formative" onchange="loadQuestions()">
                        <option value="">Choose a formative</option>
                    </select>
                </div>
                <div id="questions-list"></div>
                <button class="btn btn-secondary" onclick="showAddQuestion()" id="add-question-btn" style="display: none;">Add New Question</button>
            </div>
        </div>

        <!-- Add Question Section -->
        <div id="add-question-section" class="content-section">
            <div class="back-btn">
                <button class="btn btn-back" onclick="showManageQuestions()">← Back to Questions</button>
            </div>
            <div class="card">
                <h2>Add New Question</h2>
                <div class="form-group">
                    <label for="new-question">Question:</label>
                    <textarea id="new-question" rows="3" placeholder="Enter your question"></textarea>
                </div>
                <div class="form-group">
                    <label for="option-a">Option A:</label>
                    <input type="text" id="option-a" placeholder="Enter option A">
                </div>
                <div class="form-group">
                    <label for="option-b">Option B:</label>
                    <input type="text" id="option-b" placeholder="Enter option B">
                </div>
                <div class="form-group">
                    <label for="option-c">Option C:</label>
                    <input type="text" id="option-c" placeholder="Enter option C">
                </div>
                <div class="form-group">
                    <label for="option-d">Option D:</label>
                    <input type="text" id="option-d" placeholder="Enter option D">
                </div>
                <div class="form-group">
                    <label for="correct-answer">Correct Answer:</label>
                    <select id="correct-answer">
                        <option value="A">Option A</option>
                        <option value="B">Option B</option>
                        <option value="C">Option C</option>
                        <option value="D">Option D</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addQuestion()">Add Question</button>
            </div>
        </div>
    </div>

    <!-- REPLACE THE ENTIRE SCRIPT SECTION WITH THIS UPDATED VERSION -->
<script>// Global variables
let currentQuiz = {
    subject: '',
    formative: '',
    questions: [],
    currentQuestion: 0,
    score: 0,
    userAnswers: [],
    usedQuestions: []
};

let editingQuestionIndex = -1;

// Admin credentials
const ADMIN_CREDENTIALS = {
    username: 'admin',
    password: 'quiz2024'
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    loadFromRepository();
});

// NEW: Load data from repository files
async function loadFromRepository() {
    try {
        // Load subjects list
        const subjectsResponse = await fetch('./subjects.json');
        const subjectsData = await subjectsResponse.json();
        
        const data = { subjects: {} };
        
        // Load each subject's formatives
        for (const subject of subjectsData.subjects) {
            data.subjects[subject] = {};
            
            // Try to load formative1.json to formative4.json
            for (let i = 1; i <= 4; i++) {
                try {
                    const formativeResponse = await fetch(`./subjects/${subject}/formative${i}.json`);
                    if (formativeResponse.ok) {
                        const formativeData = await formativeResponse.json();
                        data.subjects[subject][`Formative ${i}`] = formativeData.questions;
                    }
                } catch (e) {
                    // File doesn't exist, skip
                    console.log(`Formative ${i} not found for ${subject}`);
                }
            }
        }
        
        // Save to localStorage
        localStorage.setItem('quizData', JSON.stringify(data));
        showNotification('Data loaded from repository!');
        loadSubjects();
        
    } catch (error) {
        console.error('Error loading from repository:', error);
        showNotification('Error loading from repository. Using local data.', 'error');
        initializeDefaultData();
        loadSubjects();
    }
}

// NEW: Load file content from uploaded file
function loadFileContent(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const fileData = JSON.parse(e.target.result);
            const data = JSON.parse(localStorage.getItem('quizData') || '{}');
            
            if (!data.subjects) data.subjects = {};
            if (!data.subjects[fileData.subject]) data.subjects[fileData.subject] = {};
            
            data.subjects[fileData.subject][fileData.formative.replace(/(\d+)/, ' $1').replace(/^formative/, 'Formative')] = fileData.questions;
            localStorage.setItem('quizData', JSON.stringify(data));
            
            showNotification(`Loaded: ${fileData.subject} - ${fileData.formative}!`);
            loadSubjects();
        } catch (error) {
            showNotification('Error reading file! Please check JSON format.', 'error');
        }
    };
    reader.readAsText(file);
}

// NEW: Show file upload section
function showFileUpload() {
    hideAllSections();
    document.getElementById('file-upload-section').classList.add('active');
}

// Initialize with some default data if none exists
function initializeDefaultData() {
    if (!localStorage.getItem('quizData')) {
        const defaultData = {
            subjects: {
                'php': {
                    'Formative 1': [
                        {
                            question: "What is PHP?",
                            options: ["A programming language", "A database", "An operating system", "A web browser"],
                            correct: "A"
                        },
                        {
                            question: "What does PHP stand for?",
                            options: ["Personal Home Page", "PHP: Hypertext Preprocessor", "Private Home Page", "Public HTML Page"],
                            correct: "B"
                        }
                    ]
                },
                'mathematics': {
                    'Formative 1': [
                        {
                            question: "What is 2 + 2?",
                            options: ["3", "4", "5", "6"],
                            correct: "B"
                        },
                        {
                            question: "What is 5 × 3?",
                            options: ["15", "12", "18", "20"],
                            correct: "A"
                        }
                    ]
                }
            }
        };
        localStorage.setItem('quizData', JSON.stringify(defaultData));
    }
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Navigation functions
function showHome() {
    hideAllSections();
    document.getElementById('home-section').classList.add('active');
}

function showSubjects() {
    hideAllSections();
    document.getElementById('subjects-section').classList.add('active');
    loadSubjects();
}

function showFormatives(subject) {
    currentQuiz.subject = subject;
    hideAllSections();
    document.getElementById('formatives-section').classList.add('active');
    document.getElementById('formatives-title').textContent = `${subject} - Select a Formative`;
    loadFormatives(subject);
}

function showLogin() {
    hideAllSections();
    document.getElementById('login-section').classList.add('active');
}

function showAdmin() {
    hideAllSections();
    document.getElementById('admin-section').classList.add('active');
}

function showCreateSubject() {
    hideAllSections();
    document.getElementById('create-subject-section').classList.add('active');
}

function showCreateFormative() {
    hideAllSections();
    document.getElementById('create-formative-section').classList.add('active');
    loadSubjectsForFormative();
}

function showManageQuestions() {
    hideAllSections();
    document.getElementById('manage-questions-section').classList.add('active');
    loadSubjectsForQuestions();
}

function showAddQuestion() {
    hideAllSections();
    document.getElementById('add-question-section').classList.add('active');
}

function showEditQuestion(index) {
    const subject = document.getElementById('question-subject').value;
    const formative = document.getElementById('question-formative').value;
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const question = data.subjects[subject][formative][index];
    
    editingQuestionIndex = index;
    
    document.getElementById('edit-question').value = question.question;
    document.getElementById('edit-option-a').value = question.options[0];
    document.getElementById('edit-option-b').value = question.options[1];
    document.getElementById('edit-option-c').value = question.options[2];
    document.getElementById('edit-option-d').value = question.options[3];
    document.getElementById('edit-correct-answer').value = question.correct;
    
    hideAllSections();
    document.getElementById('edit-question-section').classList.add('active');
}

function hideAllSections() {
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(section => section.classList.remove('active'));
}

// Load subjects
function loadSubjects() {
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const container = document.getElementById('subjects-container');
    container.innerHTML = '';

    Object.keys(data.subjects || {}).forEach(subject => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.innerHTML = `<h3>${subject.charAt(0).toUpperCase() + subject.slice(1)}</h3>`;
        card.onclick = () => showFormatives(subject);
        container.appendChild(card);
    });
}

// Load formatives for a subject
function loadFormatives(subject) {
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const container = document.getElementById('formatives-container');
    container.innerHTML = '';

    const subjectData = data.subjects[subject] || {};
    for (let i = 1; i <= 4; i++) {
        const formativeName = `Formative ${i}`;
        const card = document.createElement('div');
        card.className = 'formative-card';
        card.innerHTML = `<h3>${formativeName}</h3><p>${subjectData[formativeName] ? subjectData[formativeName].length : 0} questions</p>`;
        
        if (subjectData[formativeName] && subjectData[formativeName].length > 0) {
            card.onclick = () => startQuiz(subject, formativeName);
        } else {
            card.style.opacity = '0.5';
            card.style.cursor = 'not-allowed';
        }
        
        container.appendChild(card);
    }
}

// Start quiz
// Start quiz (modified to check for saved progress)
function startQuiz(subject, formative) {
    // Check for saved progress first
    if (checkSavedProgress(subject, formative)) {
        return;
    }
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const questions = data.subjects[subject][formative] || [];
    
    if (questions.length === 0) {
        showNotification('No questions available for this formative', 'error');
        return;
    }

    currentQuiz = {
        subject,
        formative,
        questions: [...questions],
        currentQuestion: 0,
        score: 0,
        userAnswers: [],
        usedQuestions: JSON.parse(localStorage.getItem(`used_${subject}_${formative}`) || '[]')
    };

    shuffleQuestions();
    
    hideAllSections();
    document.getElementById('quiz-section').classList.add('active');
    showQuestion();
}

// Shuffle questions to avoid repeats
function shuffleQuestions() {
    const availableQuestions = currentQuiz.questions.filter((_, index) => 
        !currentQuiz.usedQuestions.includes(index)
    );

    if (availableQuestions.length === 0) {
        currentQuiz.usedQuestions = [];
        localStorage.setItem(`used_${currentQuiz.subject}_${currentQuiz.formative}`, JSON.stringify([]));
        availableQuestions.push(...currentQuiz.questions);
    }

    for (let i = availableQuestions.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [availableQuestions[i], availableQuestions[j]] = [availableQuestions[j], availableQuestions[i]];
    }

    currentQuiz.questions = availableQuestions.slice(0, Math.min(20, availableQuestions.length));
}

// Show current question
function showQuestion() {
    const question = currentQuiz.questions[currentQuiz.currentQuestion];
    const progress = ((currentQuiz.currentQuestion + 1) / Math.min(20, currentQuiz.questions.length)) * 100;
    
    document.getElementById('progress-bar').style.width = progress + '%';
    
    const container = document.getElementById('quiz-content');
    container.innerHTML = `
        <div class="question-card">
            <div class="question-number">Question ${currentQuiz.currentQuestion + 1} of ${Math.min(20, currentQuiz.questions.length)}</div>
            <div class="question-text">${question.question}</div>
            <div class="options-container">
                <div class="option" onclick="selectOption(0, 'A')">${question.options[0]}</div>
                <div class="option" onclick="selectOption(1, 'B')">${question.options[1]}</div>
                <div class="option" onclick="selectOption(2, 'C')">${question.options[2]}</div>
                <div class="option" onclick="selectOption(3, 'D')">${question.options[3]}</div>
            </div>
        </div>
    `;
}

// Select option
function selectOption(index, letter) {
    const options = document.querySelectorAll('.option');
    const question = currentQuiz.questions[currentQuiz.currentQuestion];
    
    options.forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
    options[index].classList.add('selected');
    
    const isCorrect = letter === question.correct;
    
    setTimeout(() => {
        options[index].classList.add(isCorrect ? 'correct' : 'incorrect');
        
        if (!isCorrect) {
            const correctIndex = ['A', 'B', 'C', 'D'].indexOf(question.correct);
            options[correctIndex].classList.add('correct');
        }
        
        if (isCorrect) {
            currentQuiz.score++;
        }
        currentQuiz.userAnswers.push({ question: currentQuiz.currentQuestion, answer: letter, correct: isCorrect });
        
        const originalIndex = currentQuiz.questions.findIndex(q => q.question === question.question);
        if (!currentQuiz.usedQuestions.includes(originalIndex)) {
            currentQuiz.usedQuestions.push(originalIndex);
            localStorage.setItem(`used_${currentQuiz.subject}_${currentQuiz.formative}`, JSON.stringify(currentQuiz.usedQuestions));
        }
        
        setTimeout(() => {
            currentQuiz.currentQuestion++;
            if (currentQuiz.currentQuestion < Math.min(20, currentQuiz.questions.length)) {
                showQuestion();
            } else {
                showResults();
            }
        }, 1500);
    }, 500);
}

// Show quiz results (modified to clear saved progress)
function showResults() {
    // Clear saved progress when quiz is completed

    const totalQuestions = Math.min(20, currentQuiz.questions.length);
    const percentage = Math.round((currentQuiz.score / totalQuestions) * 100);
    
    hideAllSections();
    document.getElementById('results-section').classList.add('active');
    
    const scoreElement = document.getElementById('final-score');
    const messageElement = document.getElementById('score-message');
    
    scoreElement.textContent = `${currentQuiz.score}/${totalQuestions} (${percentage}%)`;
    
    if (percentage >= 90) {
        scoreElement.className = 'score excellent';
        messageElement.textContent = 'Excellent work! You have mastered this topic.';
    } else if (percentage >= 70) {
        scoreElement.className = 'score good';
        messageElement.textContent = 'Good job! You have a solid understanding.';
    } else if (percentage >= 50) {
        scoreElement.className = 'score average';
        messageElement.textContent = 'Not bad, but there\'s room for improvement.';
    } else {
        scoreElement.className = 'score poor';
        messageElement.textContent = 'Keep studying and try again!';
    }
}

// Admin login
function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        showNotification('Login successful!');
        showAdmin();
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    } else {
        showNotification('Invalid credentials!', 'error');
    }
}

// Logout
function logout() {
    showNotification('Logged out successfully!');
    showHome();
}

// Create new subject
// Create new subject with file downloads
function createSubject() {
    const subjectName = document.getElementById('subject-name').value.trim().toLowerCase();
    
    if (!subjectName) {
        showNotification('Please enter a subject name!', 'error');
        return;
    }
    
    // Validation
    if (!/^[a-zA-Z0-9_-]+$/.test(subjectName)) {
        showNotification('Subject name can only contain letters, numbers, hyphens, and underscores!', 'error');
        return;
    }
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    if (!data.subjects) data.subjects = {};
    
    if (data.subjects[subjectName]) {
        showNotification('Subject already exists!', 'error');
        return;
    }
    
    // Add subject to data
    data.subjects[subjectName] = {};
    
    // Create formative placeholders
    for (let i = 1; i <= 4; i++) {
        data.subjects[subjectName][`Formative ${i}`] = [];
    }
    
    localStorage.setItem('quizData', JSON.stringify(data));
    
    // Update subjects list for file download
    const subjectsList = JSON.parse(localStorage.getItem('customSubjects') || '[]');
    if (!subjectsList.includes(subjectName)) {
        subjectsList.push(subjectName);
        localStorage.setItem('customSubjects', JSON.stringify(subjectsList));
    }
    
    // Create downloadable files
    createSubjectFiles(subjectName);
    
    showNotification(`Subject "${subjectName}" created successfully! Files are being downloaded.`);
    document.getElementById('subject-name').value = '';
    showAdmin();
}

// Create and download subject files
function createSubjectFiles(subjectName) {
    // Update subjects.json
    const existingSubjects = JSON.parse(localStorage.getItem('repositorySubjects') || '[]');
    if (!existingSubjects.includes(subjectName)) {
        existingSubjects.push(subjectName);
        localStorage.setItem('repositorySubjects', JSON.stringify(existingSubjects));
    }
    
    const subjectsData = { subjects: existingSubjects };
    downloadFile('subjects.json', JSON.stringify(subjectsData, null, 2));
    
    // Create formative files
    for (let i = 1; i <= 4; i++) {
        const formativeData = {
            subject: subjectName,
            formative: `formative${i}`,
            questions: []
        };
        
        // Use setTimeout to stagger downloads
        setTimeout(() => {
            downloadFile(`${subjectName}_formative${i}.json`, JSON.stringify(formativeData, null, 2));
        }, i * 200);
    }
    
    // Show instruction
    setTimeout(() => {
        alert(`Files downloaded! Please:\n1. Create folder: subjects/${subjectName}/\n2. Move formative files to that folder\n3. Update subjects.json in root\n4. Commit to GitHub`);
    }, 1000);
}

// Download file function
function downloadFile(filename, content) {
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
// Load subjects for formative creation
// Load subjects (including custom ones)
function loadSubjects() {
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const container = document.getElementById('subjects-container');
    container.innerHTML = '';

    // Combine repository subjects and custom subjects
    const allSubjects = Object.keys(data.subjects || {});
    
    allSubjects.forEach(subject => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        
        // Check if it's a custom subject
        const customSubjects = JSON.parse(localStorage.getItem('customSubjects') || '[]');
        const isCustom = customSubjects.includes(subject);
        
        card.innerHTML = `
            <h3>${subject.charAt(0).toUpperCase() + subject.slice(1)}</h3>
            ${isCustom ? '<small style="color: #64ffda;">Custom Subject</small>' : ''}
        `;
        card.onclick = () => showFormatives(subject);
        container.appendChild(card);
    });
}

// Quit quiz with confirmation
function quitQuiz() {
    if (confirm('Are you sure you want to quit? Your progress will be saved.')) {
        // Save current progress
        const progress = {
            subject: currentQuiz.subject,
            formative: currentQuiz.formative,
            currentQuestion: currentQuiz.currentQuestion,
            score: currentQuiz.score,
            questions: currentQuiz.questions,
            userAnswers: currentQuiz.userAnswers,
            usedQuestions: currentQuiz.usedQuestions,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('savedQuizProgress', JSON.stringify(progress));
        showNotification('Quiz progress saved!');
        showHome();
    }
}

// Check for saved progress when starting quiz
function checkSavedProgress(subject, formative) {
    const savedProgress = localStorage.getItem('savedQuizProgress');
    if (savedProgress) {
        const progress = JSON.parse(savedProgress);
        if (progress.subject === subject && progress.formative === formative) {
            currentQuiz = progress;
            document.getElementById('resume-subject').textContent = subject;
            document.getElementById('resume-formative').textContent = formative;
            document.getElementById('resume-progress').textContent = `${progress.currentQuestion + 1}/${progress.questions.length} questions`;
            
            hideAllSections();
            document.getElementById('resume-section').classList.add('active');
            return true;
        }
    }
    return false;
}

// Resume saved quiz
function resumeQuiz() {
    hideAllSections();
    document.getElementById('quiz-section').classList.add('active');
    showQuestion();
}

// Start new quiz (clear saved progress)
function startNewQuiz() {
    localStorage.removeItem('savedQuizProgress');
    startQuiz(currentQuiz.subject, currentQuiz.formative);
}

// Create new formative
function createFormative() {
    const subject = document.getElementById('formative-subject').value;
    const formativeNumber = document.getElementById('formative-number').value;
    
    if (!subject) {
        showNotification('Please select a subject!', 'error');
        return;
    }
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const formativeName = `Formative ${formativeNumber}`;
    
    if (!data.subjects[subject]) {
        data.subjects[subject] = {};
    }
    
    if (data.subjects[subject][formativeName]) {
        showNotification('Formative already exists!', 'error');
        return;
    }
    
    data.subjects[subject][formativeName] = [];
    localStorage.setItem('quizData', JSON.stringify(data));
    
    showNotification('Formative created successfully!');
    showAdmin();
}

// Load subjects for questions management
function loadSubjectsForQuestions() {
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const select = document.getElementById('question-subject');
    select.innerHTML = '<option value="">Choose a subject</option>';
    
    Object.keys(data.subjects || {}).forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        select.appendChild(option);
    });
}

// Load formatives for questions management
function loadFormativesForQuestions() {
    const subject = document.getElementById('question-subject').value;
    const select = document.getElementById('question-formative');
    select.innerHTML = '<option value="">Choose a formative</option>';
    
    if (!subject) return;
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const subjectData = data.subjects[subject] || {};
    
    Object.keys(subjectData).forEach(formative => {
        const option = document.createElement('option');
        option.value = formative;
        option.textContent = formative;
        select.appendChild(option);
    });
}

// Load questions with edit buttons
function loadQuestions() {
    const subject = document.getElementById('question-subject').value;
    const formative = document.getElementById('question-formative').value;
    const container = document.getElementById('questions-list');
    const addBtn = document.getElementById('add-question-btn');
    
    if (!subject || !formative) {
        container.innerHTML = '';
        addBtn.style.display = 'none';
        return;
    }
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const questions = data.subjects[subject][formative] || [];
    
    container.innerHTML = '<h3>Questions:</h3>';
    
    questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'card';
        questionDiv.style.marginBottom = '15px';
        questionDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <strong>Q${index + 1}:</strong> ${question.question}<br>
                    <strong>A:</strong> ${question.options[0]}<br>
                    <strong>B:</strong> ${question.options[1]}<br>
                    <strong>C:</strong> ${question.options[2]}<br>
                    <strong>D:</strong> ${question.options[3]}<br>
                    <strong>Correct:</strong> ${question.correct}
                </div>
                <div style="display: flex; gap: 10px; margin-left: 10px;">
                    <button class="btn btn-primary" onclick="showEditQuestion(${index})" style="padding: 8px 16px;">Edit</button>
                    <button class="btn btn-secondary" onclick="deleteQuestion(${index})" style="padding: 8px 16px;">Delete</button>
                </div>
            </div>
        `;
        container.appendChild(questionDiv);
    });
    
    addBtn.style.display = 'block';
}

// Delete question
function deleteQuestion(index) {
    const subject = document.getElementById('question-subject').value;
    const formative = document.getElementById('question-formative').value;
    
    if (confirm('Are you sure you want to delete this question?')) {
        const data = JSON.parse(localStorage.getItem('quizData') || '{}');
        data.subjects[subject][formative].splice(index, 1);
        localStorage.setItem('quizData', JSON.stringify(data));
        
        showNotification('Question deleted successfully!');
        loadQuestions();
    }
}

// Update existing question
function updateQuestion() {
    const subject = document.getElementById('question-subject').value;
    const formative = document.getElementById('question-formative').value;
    const question = document.getElementById('edit-question').value.trim();
    const optionA = document.getElementById('edit-option-a').value.trim();
    const optionB = document.getElementById('edit-option-b').value.trim();
    const optionC = document.getElementById('edit-option-c').value.trim();
    const optionD = document.getElementById('edit-option-d').value.trim();
    const correct = document.getElementById('edit-correct-answer').value;
    
    if (!question || !optionA || !optionB || !optionC || !optionD) {
        showNotification('Please fill in all fields!', 'error');
        return;
    }
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const updatedQuestion = {
        question,
        options: [optionA, optionB, optionC, optionD],
        correct
    };
    
    data.subjects[subject][formative][editingQuestionIndex] = updatedQuestion;
    localStorage.setItem('quizData', JSON.stringify(data));
    
    showNotification('Question updated successfully!');
    showManageQuestions();
}

// Add new question
function addQuestion() {
    const subject = document.getElementById('question-subject').value;
    const formative = document.getElementById('question-formative').value;
    const question = document.getElementById('new-question').value.trim();
    const optionA = document.getElementById('option-a').value.trim();
    const optionB = document.getElementById('option-b').value.trim();
    const optionC = document.getElementById('option-c').value.trim();
    const optionD = document.getElementById('option-d').value.trim();
    const correct = document.getElementById('correct-answer').value;
    
    if (!question || !optionA || !optionB || !optionC || !optionD) {
        showNotification('Please fill in all fields!', 'error');
        return;
    }
    
    const data = JSON.parse(localStorage.getItem('quizData') || '{}');
    const newQuestion = {
        question,
        options: [optionA, optionB, optionC, optionD],
        correct
    };
    
    data.subjects[subject][formative].push(newQuestion);
    localStorage.setItem('quizData', JSON.stringify(data));
    
    showNotification('Question added successfully!');
    
    // Clear form
    document.getElementById('new-question').value = '';
    document.getElementById('option-a').value = '';
    document.getElementById('option-b').value = '';
    document.getElementById('option-c').value = '';
    document.getElementById('option-d').value = '';
    document.getElementById('correct-answer').value = 'A';
    
    showManageQuestions();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        showHome();
    }
});
</script>
</body>
</html>